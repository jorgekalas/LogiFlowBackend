extends ../layout

block content
  h2.mb-4 Nuevo Env칤o

  if error
    .alert.alert-danger.text-center #{error}

  form(method="post", action="/shipments")

    // Cliente
    .mb-3
      label.form-label(for="client") Cliente
      select.form-select(name="client" required)
        option(value="") Seleccion치 un cliente
        each c in clients
          option(
            value=c._id
            selected=(formData && formData.client && String(formData.client) === String(c._id))
          ) #{c.name} (#{c.email})

    // Origen
    .mb-3
      label.form-label(for="origin") Origen
      input.form-control(
        type="text"
        name="origin"
        required
        value=(formData && formData.origin) || ""
      )

    // Destino
    .mb-3
      label.form-label(for="destination") Destino
      input.form-control(
        type="text"
        name="destination"
        required
        value=(formData && formData.destination) || ""
      )

    // Estado
    .mb-3
      label.form-label(for="status") Estado
      select.form-select(name="status")
        option(value="pendiente" selected=(formData && formData.status === "pendiente")) pendiente
        option(value="en tr치nsito" selected=(formData && formData.status === "en tr치nsito")) en tr치nsito
        option(value="entregado" selected=(formData && formData.status === "entregado")) entregado

    // Productos
    h5.mt-4 Productos
    p.text-muted Ingres치 la cantidad para cada producto (0 para no incluirlo)

    input.form-control.mb-3#filterInput(type="text", placeholder="游댌 Buscar producto por nombre...")

    .product-list#productList

    .mt-4.mb-5.text-center
      button.btn.btn-success(type="submit") Guardar
      a.btn.btn-secondary.ms-2(href="/shipments") Cancelar

  script.
    const filterInput = document.getElementById('filterInput');
    const productList = document.getElementById('productList');
    const products = !{JSON.stringify(products)};
    const saved = !{JSON.stringify(formData && formData.quantities ? formData.quantities : {})};

    function renderProducts(list) {
      productList.innerHTML = '';

      if (list.length === 0) {
        const p = document.createElement('p');
        p.className = 'text-muted';
        p.textContent = 'No se encontraron productos.';
        productList.appendChild(p);
        return;
      }

      list.forEach(prod => {
        const div = document.createElement('div');
        const savedQty = saved[prod._id] || 0;

        div.className = 'product-item border rounded p-3 mb-2 bg-light';
        div.innerHTML = `
          <label class="form-label mb-1">
            ${prod.name} 
            <span class="text-muted small">(stock: ${prod.stock})</span>
          </label>
          <input class="form-control" 
            type="number" 
            min="0"
            name="quantities[${prod._id}]"
            value="${savedQty}">
        `;

        productList.appendChild(div);
      });
    }

    renderProducts(products);

    filterInput.addEventListener('input', e => {
      const term = e.target.value.toLowerCase();
      renderProducts(products.filter(p => p.name.toLowerCase().includes(term)));
    });
